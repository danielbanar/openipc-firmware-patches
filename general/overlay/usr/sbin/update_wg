#!/bin/sh

CONFIG_FILE="/etc/wireguard.conf"
INTERFACES_FILE="/etc/network/interfaces.d/wg0"
CONFIG_TXT_FILE="/root/wireguard"

# Load configuration as shell variables
if [ -e "$CONFIG_TXT_FILE" ]; then
    . "$CONFIG_TXT_FILE"
else
    echo "Error: Config file $CONFIG_TXT_FILE not found."
    exit 1
fi

# Optional control flag
if [ "$enabled" != "true" ]; then
    echo "WireGuard not enabled â€” exiting."
    exit 0
fi

# Validate required vars
for var in domain PrivateKey PublicKey PresharedKey IP; do
    eval val=\$$var
    [ -z "$val" ] && { echo "Error: Missing variable $var in $CONFIG_TXT_FILE."; exit 1; }
done

# Resolve domain to IP
RESOLVED_IP=$(nslookup "$domain" | awk '/^Address: / { print $2 }' | tail -n1)
[ -z "$RESOLVED_IP" ] && { echo "Error: Could not resolve $domain"; exit 1; }

# Update /etc/wireguard.conf
if [ -f "$CONFIG_FILE" ]; then
    sed -i -E "s|^(Endpoint[ \t]*=[ \t]*)[0-9.]+(:[0-9]+)$|\1$RESOLVED_IP\2|" "$CONFIG_FILE"
    sed -i -E "s|^(PrivateKey[ \t]*=[ \t]*).*$|\1$PrivateKey|" "$CONFIG_FILE"
    sed -i -E "s|^(PublicKey[ \t]*=[ \t]*).*$|\1$PublicKey|" "$CONFIG_FILE"
    sed -i -E "s|^(PresharedKey[ \t]*=[ \t]*).*$|\1$PresharedKey|" "$CONFIG_FILE"
    echo "Updated $CONFIG_FILE."
else
    echo "Error: $CONFIG_FILE not found."
    exit 1
fi

# Update /etc/network/interfaces.d/wg0
if [ -f "$INTERFACES_FILE" ]; then
    sed -i -E "s|^( *address[ \t]+)[0-9.]+|\1$IP|" "$INTERFACES_FILE"
    echo "Updated $INTERFACES_FILE."
else
    echo "Error: $INTERFACES_FILE not found."
    exit 1
fi